(function(){if(!("serviceWorker"in navigator)){return}var serviceWorker=navigator.serviceWorker;var constants=function(){var scriptRegisterStrategies={UN_REGISTER:"unregister",REGISTER:"register",REGISTER_IGNORE_FAILURE:"registerIgnoreFailure",UPDATE:"update"};return{versionTagSymbol:"v",scriptQuerySymbol:"script",scriptStrategyQuerySymbol:"strategy",scriptVersionQuerySymbol:"version",scriptInvokeTimeQuerySymbol:"invokeTime",defaultScriptInvokeTime:"DOMContentLoaded",scriptRegisterStrategies:scriptRegisterStrategies}}();var utils=function(){var _getTempAnchorElement=function _getTempAnchorElement(){return document.createElement("a")};var mb=function mb(p){return function(o){return p.map(function(c){return o=(o||{})[c]})&&o}};var _utils={mb:mb,calcSwScriptURL:mb(["active","scriptURL"]),updateQueryStringParam:function updateQueryStringParam(uri,key,value){if(!value){return uri}var re=new RegExp("([?&])"+key+"=.*?(&|$)","i");var separator=uri.indexOf("?")!==-1?"&":"?";return re.test(uri)?uri.replace(re,"$1"+key+"="+value+"$2"):uri+separator+key+"="+value},removeQueryStringParam:function removeQueryStringParam(uri,keys){[].concat(keys).map(function(key){if(!key){return}var re=new RegExp("([?&])"+key+"=.*?(&|$)","i");if(re.test(uri)){uri=uri.replace(re,function(str,$1,$2){return $1&&$1.startsWith("?")?$2.replace("&","?"):$2})}});return uri},getQueryStringFormTargetSearch:function getQueryStringFormTargetSearch(targetSearchString,name,ignoreCase){if(!(targetSearchString&&typeof targetSearchString==="string")){return null}var reg=new RegExp("(?:[?|&]?)"+name+"=([^&]*)(?:&|$)",ignoreCase?"i":undefined);var r=targetSearchString.match(reg);if(r!=null)return decodeURIComponent(r[1]);return null},getDefaultSiteVersion:function getDefaultSiteVersion(){var $siteVersionMeta=document.querySelector('meta[itemprop="version"]');if($siteVersionMeta){return $siteVersionMeta.content||undefined}},formatUrl:function formatUrl(urlString){var anchorEle=_getTempAnchorElement();anchorEle.href=urlString;return{href:anchorEle.href,origin:anchorEle.origin,host:anchorEle.host,hostname:anchorEle.hostname,port:anchorEle.port,pathname:anchorEle.pathname,protocol:anchorEle.protocol,search:anchorEle.search,hash:anchorEle.hash,password:anchorEle.password,username:anchorEle.username}},findMatchedServiceWorkerIns:function findMatchedServiceWorkerIns(targetUrl){var targetUrlPathname=_utils.formatUrl(targetUrl).pathname;return serviceWorker.getRegistrations().then(function(registrations){return registrations.find(function(reg){var urlPathname=_utils.formatUrl(_utils.calcSwScriptURL(reg)).pathname;if(urlPathname){return targetUrlPathname===urlPathname}})})},unRegisterServiceWorker:function unRegisterServiceWorker(targetUrl){return _utils.findMatchedServiceWorkerIns(targetUrl).then(function(matchedReg){if(!matchedReg){return matchedReg}return matchedReg.unregister().then(function(result){if(result){console.log("[SERVICE_WORKER] De-Registration success.",targetUrl)}return result})})},registerServiceWorker:function registerServiceWorker(targetUrl,options){options=options||{};var swMainUrl=targetUrl;var scriptVersion=options.scriptVersion||_utils.getDefaultSiteVersion();if(scriptVersion){swMainUrl=utils.updateQueryStringParam(swMainUrl,constants.versionTagSymbol,scriptVersion)}var _mainFunc=function _mainFunc(){return serviceWorker.register(swMainUrl).then(function(registration){console.log("[SERVICE_WORKER] Registration success.",targetUrl);return registration})};return _utils.findMatchedServiceWorkerIns(targetUrl).then(function(matchedReg){if(!matchedReg){return _mainFunc()}if(options.forceUpdate){return matchedReg.unregister().then(_mainFunc)}var swScriptUrl=_utils.calcSwScriptURL(matchedReg);var versionTag=utils.getQueryStringFormTargetSearch(swScriptUrl,constants.versionTagSymbol);if(versionTag&&scriptVersion&&scriptVersion===versionTag){return}return matchedReg.unregister().then(_mainFunc)})}};return _utils}();var getters=function(){var _getters={currentScriptUrl:utils.mb(["currentScript","src"])(document)};_getters.targetSwScriptUrl=decodeURIComponent(utils.getQueryStringFormTargetSearch(_getters.currentScriptUrl,constants.scriptQuerySymbol)||"");_getters.registerVersion=utils.getQueryStringFormTargetSearch(_getters.currentScriptUrl,constants.versionTagSymbol);_getters.targetSwScriptStrategy=utils.getQueryStringFormTargetSearch(_getters.currentScriptUrl,constants.scriptStrategyQuerySymbol);_getters.targetSwScriptVersion=utils.getQueryStringFormTargetSearch(_getters.currentScriptUrl,constants.scriptVersionQuerySymbol)||undefined;_getters.targetSwScriptInvokeTime=utils.getQueryStringFormTargetSearch(_getters.currentScriptUrl,constants.scriptInvokeTimeQuerySymbol)||constants.defaultScriptInvokeTime;return _getters}();var events=function(){return{_init:function _init(){var targetSwScriptUrl=getters.targetSwScriptUrl;var swScriptStrategy=getters.targetSwScriptStrategy;var swScriptVersion=getters.targetSwScriptVersion;var swScriptInvokeTime=getters.targetSwScriptInvokeTime;var scriptRegisterStrategies=constants.scriptRegisterStrategies;if(!targetSwScriptUrl){return}window.addEventListener(swScriptInvokeTime,function(){if(swScriptStrategy===scriptRegisterStrategies.UN_REGISTER){return utils.unRegisterServiceWorker(targetSwScriptUrl)}return utils.registerServiceWorker(targetSwScriptUrl,{scriptVersion:swScriptVersion||getters.registerVersion,forceUpdate:swScriptStrategy===scriptRegisterStrategies.UPDATE}).catch(function(err){console.error("[SERVICE_WORKER] Registration failed.",targetSwScriptUrl,err);if(scriptRegisterStrategies.REGISTER_IGNORE_FAILURE===swScriptStrategy){return}return utils.unRegisterServiceWorker(targetSwScriptUrl)})})}}}();events._init()})();